#!/usr/bin/env python

import argparse
from pprint import pprint
import sys

from doconce2.core.processor import Processor, solve_dependencies
from doconce2.parsers import structure
from doconce2.parsers import markdown
from doconce2 import utils
from doconce2 import plugin_source

def main():
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(dest="subparser_name")

    format_parser = subparsers.add_parser("format")
    format_parser.add_argument("format")
    format_parser.add_argument("filename")
    args = parser.parse_args()

    available_processors = []

    for plugin_name in plugin_source.list_plugins():
        plugin = plugin_source.load_plugin(plugin_name)
        available_processors += plugin.setup_processors()

    if args.subparser_name == "format":
        if args.format == "ipynb":
            document = structure.parse_file(args.filename)
            structure.process_includes(document)
            structure.process_blocks(document)
            markdown.process_markdown(document)
            pprint(document)
        elif args.format == "test":
            document = structure.parse_file(args.filename)

            enabled_processors = [
                "core"
            ]

            processors = solve_dependencies(
                available_processors,
                enabled_processors
            )

            for processor in processors:
                processor.function(document)

            pprint(document)

    return 0

if __name__ == "__main__":
    sys.exit(main())
